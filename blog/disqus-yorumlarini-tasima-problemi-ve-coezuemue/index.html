<!DOCTYPE html>
<html>
<head>
  <style type="text/css">

    body {
      max-width: 40em;
      margin: 4em auto;
    }

    pre {
      font-family: inherit;
      color: inherit;
      background: #ccc;
      border: 1px solid #000;
      padding: 1em;
      overflow: auto;
    }

    ul.nav {
      list-style-type: none;
      overflow: auto;
      padding: 0;
    }

    ul.nav li {
      float: left;
      margin: 0 20px 0 0;
    }

    img {
      max-width: 100%;
    }
    li {
      margin-bottom: 0.25em;
    }
    span.date {
      font-size: 0.7em;
      float: right;
    }
    table {
      width: 100%;
    }
    th, td {
      border-bottom: 1px solid black;
      padding: 0.25em;
      text-align: left;
    }
    img {
      left: 0;
      right: 0;
      margin-right: auto;
      margin-left: auto;
    }   

  </style>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Disqus Yorumlarını Taşıma Problemi ve Çözümü — Mirat Can Bayrak</title>
</head>
<body>
<ul class="nav">
  <li>
    <a href="../../">Anasayfa</a></li>
    
      <li class="active">
        <a href="../../blog/">Blog</a>
      </li>
    
      <li>
        <a href="../../projeler/">Projeler</a>
      </li>
    
</ul>

  
  <h1>Disqus Yorumlarını Taşıma Problemi ve Çözümü</h1>
  <p>Kişisel blogumu Tumblr'dan taşımak istedim. Taşımak isteme sebebim Lektor oldu. Lektor Markdown tabanlı bir statik web sitesi jeneratörü bu yazının konusu olmayan bir çok güzel özelliği var. Yeni siteye eski blogdan yazıları taşıdıktan sonra Disqus'daki yorumları yeni domaine ve yazı adreslemelerine taşımam gerekti. Sadece domain değiştiğinde yani taşınma şemamız aşağıdaki gibiyse sadece domaini değiştirerek taşınma işini halledebiliyoruz:</p>
<table>
<thead><tr>
<th>Eski Adres</th>
<th>Yeni Adres </th>
</tr>
</thead>
<tbody>
<tr>
<td>site1.com/adres1/</td>
<td>site2.com/adres1/</td>
</tr>
<tr>
<td>site1.com/adres2/</td>
<td>site2.com/adres2/</td>
</tr>
</tbody>
</table>
<p>Ancak benim taşınma şemam bu kadar basit değildi, hem domain değişiyor hem de her yazının adresi de değişiyordu:</p>
<table>
<thead><tr>
<th>Eski Adres</th>
<th>Yeni Adres </th>
</tr>
</thead>
<tbody>
<tr>
<td>site1.com/adres1/</td>
<td>site2.com/adres2/</td>
</tr>
<tr>
<td>site1.com/adres3/</td>
<td>site2.com/adres4/</td>
</tr>
</tbody>
</table>
<p>Bu durumda Disqus, blogda şimdiye kadar Disqus penceresi en az bir defa render edilmiş gönderilerin olduğu bir CSV dosyası veriyor, CSV dosyanın içerisinde her adresin karşılığına hangi adresin geldiğini yazıp tekrar upload etmemizi istiyor. Şu adresten yapılıyor demek isterdim fakat biraz bulması zor hem de doğru düzgün bir URL'e sahip değil bu sayfa. Şu adımları takip edebilirsiniz:</p>
<ol>
<li>Disqus'a giriş yap</li>
<li>Ana sayfadaki <em>Admin</em> bağlantısına tıkla</li>
<li><em>Moderate Comments</em> bağlantısına tıkla</li>
<li>Solda <em>Tools</em> menüsünden <em>Migration Tools</em>'a gir</li>
<li>Taşımak istediğin siteyi seç</li>
<li>Karşına çıkan sayfadan <em>Start URL Mapper</em> butonuna tıkla</li>
<li>Buradan <em>you can download your csv here</em> bağlantısına tıkla</li>
<li>Eposta adresine git ve Disqus'dan gelen maili açarak CSV dosyasını al</li>
</ol>
<p>Buraya kadar güzel, ancak işler indirdiğim CSV dosyasını incelediğimde değişmeye başladı. Aşağıda elime geçen CSV dosyasından bir kesit var:</p>
<table>
<thead><tr>
<th>Adres</th>
</tr>
</thead>
<tbody>
<tr>
<td> <a href="http://miratcan.tumblr.com/post/14315717349">http://miratcan.tumblr.com/post/14315717349</a></td>
</tr>
<tr>
<td> <a href="http://miratcan.tumblr.com/post/16236379665">http://miratcan.tumblr.com/post/16236379665</a></td>
</tr>
<tr>
<td> <a href="http://miratcan.tumblr.com/post/16422262730">http://miratcan.tumblr.com/post/16422262730</a></td>
</tr>
<tr>
<td> <a href="http://miratcan.tumblr.com/post/14315714972">http://miratcan.tumblr.com/post/14315714972</a></td>
</tr>
<tr>
<td> <a href="http://miratcan.tumblr.com/post/16597868308">http://miratcan.tumblr.com/post/16597868308</a></td>
</tr>
</tbody>
</table>
<p>Bağlantılara tek tek tıklayıp kontrol edersek 404 veren sayfalar olduğunu görüyoruz. Disqus benim sildiğim, artık 404 veren sayfaları ayıklamamış, öte yandan asılnda hiç yorum olmayan sayfaların linklerini de benim CSV dosyama eklemiş. Elimde 575 satırlık satırlık eminim çoğu çöp olan bir adres listesi var. Açıkcası bu noktada biraz Disqus kullandığıma pişman oldum. Zira bu listeyi ya elle ya da çeşitli scriptlerle temizlemem gerekiyor. Öncelikle yapmak istediğim şey 404 veren sayfaları bu listeden çıkarmak.</p>
<p>Öncelikle dosyanın içeriğini okuyup tek tek basan haliyle başlayalım:</p>
<pre><code># temizle.py

line = raw_input()
while line:
    print line
    try:
        line = raw_input()
    except EOFError:
        line = None
</code></pre>
<p>Bu scriptte (hala betik mi script mi diyeceğime karar veremiyorum) herhangi bir dosya açma fonksiyonu yok. Çalıştırıp her satırda elle URL vererek ya da bir dosyanın içeriğini giriş olarak yönlendirerek kullanabiliriz. Örneğin ben elimdeki CSV dosyasını şu şekilde yönlendiriyorum:</p>
<pre><code>python temizle1.py &lt; miratcan-tumblr-2016-10-07T11-54-35.472943-links.csv
</code></pre>
<p>Şimdi urlopen komutu ile elimize geçen linklere ulaşmaya çalışalım. urlopen standart urllib2 kütüphanesinin içinde yer alıyor, parametre olarak URL alıyor ve karşılığında bir dosya benzeri obje veriyor. Eğer verilen URL ulaşılamaz ise HTTPError kaldırıyor. Yukarıdaki kodu eğer sadece bağlantı ulaşılabiliyorsa basan</p>
<pre><code># temizle.py

from urllib2 import urlopen, HTTPError

line = raw_input()
while line:

    try:
        remote = urlopen(line)
    except HTTPError:
        remote = None

    if remote:
        print line

    try:
        line = raw_input()
    except EOFError:
        line = None
</code></pre>
<p>Programın çıktısı 181 satır oldu, 575 satırdan çok daha iyi, 1/3 oranında azalma var. Fakat yetmez. Bu gönderilerin çoğu hiç yorum almadı. Blogum çok yorum alan bir blog değil. Disqus bunu da filtre etmemiş bize.  Kısa bir araştırmayla <a href="https://disqus.com/api/docs/threads/set/">api üzerinden bir gönderiya ait kaç yorum olduğunu okumanın yolunu</a> buldum. Dökümantasyonda yazdığına göre <a href="https://disqus.com/api/3.0/threads/set.json">https://disqus.com/api/3.0/threads/set.json</a> adresine bir GET talebi yapmak gerekiyor. Bu talep forum-id'sini ve thread linkini ve son olarak da api_secret değerini göndermek gerekiyor. Api secret anahtarını oluşturabilmek için <a href="https://disqus.com/api/applications/">https://disqus.com/api/applications/</a> adresine gidip bir uygulama oluşturmak gerekli.</p>
<p>Verilen linkte kaç adet yorum olduğunu hesaplamayı ayrı bir dosyada yazalım:</p>
<pre><code>from urllib import urlencode, urlopen
from json import loads

API_SECRET = '...BURAYI DOLDUR...'
FORUM_ID = '...BURAYI DOLDUR...'


def get_comment_count(url):
    params = urlencode({
        'forum': FORUM_ID,
        'thread': 'link:%s' % url,
        'api_secret': API_SECRET
    })
    api_url = 'https://disqus.com/api/3.0/threads/set.json?%s' % params
    data = urlopen(api_url).read()
    json = loads(data)
    return json['response'][0]['posts']

print get_comment_count(raw_input())
</code></pre>

  <hr />
  <p>Mirat - October 2016</p>

</body>
</html>


