<!DOCTYPE html>
<html lang="en">

<head>
  <style>
    @font-face {
      font-family: Dos;
      src: url(/dos.ttf);
    }

    :root {
      --c0: #000000;
      --c1: #000080;
      --c2: #00aaaa;
      --c3: #00aa00;
      --c4: #aa00aa;
      --c5: #aa0000;
      --c6: #aa5500;
      --c7: #aaaaaa;
      --c8: #555555;
      --c9: #5555ff;
      --c10: #1fdbdb;
      --c12: #55ff55;
      --c12: #ff55ff;
      --c13: #ff5555;
      --c14: #ffff55;
      --c15: #ffffff;
      --ln: 2px;
      --gap: 1rem;
      --fs: 16px;
      --lh: 24px;
    }

    em {
      color: var(--c6);
      font-style: normal;
    }

    strong {
      font-weight: normal;
      color: var(--c15);
    }

    ::-webkit-scrollbar {
      width: var(--gap)
    }

    ::-webkit-scrollbar-track {
      background: var(--c7);
    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
      background: var(--c8);
    }

    /* Handle on hover */
    ::-webkit-scrollbar-thumb:hover {
      background: var(--c4);
    }

    .screen *:not(pre) {
      font-size: inherit;
      line-height: inherit;
    }

    .wrapper {
      max-width: 800px;
      margin: 0 auto;
    }

    html,
    body {
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--c0);
      color: var(--c7);
      font-family: 'Dos', monospace;
      font-size: var(--fs);
      line-height: var(--lh);
      vertical-align: center;
      font-smooth: never;
      -webkit-font-smoothing: none;
      letter-spacing: -1px;
    }

    pre {
      font-family: inherit;
      padding: 1rem;
      background: #111;
      border: 1px solid gray;
      overflow-y: scroll;
    }

    code {
      color: var(--c3);
      font-family: inherit;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    p,
    li,
    table,
    blockquote {
      font-weight: normal;
      margin: 0 0 1rem 0;
      font-family: inherit;
      font-size: inherit;
      line-height: inherit;
      letter-spacing: inherit;
    }

    li {
      margin: 0;
    }

    h1 {
      font-size: 1.4em;
      line-height: 1.73em;
      text-transform: uppercase;
      text-align: center;
    }

    h2 {
      font-size: 1.3em;
      line-height: 1.61em;
      border-bottom: 4px double var(--c4);
    }

    h3 {
      line-height: 1.48em;
    }

    h1,
    h2,
    h3 {
      color: var(--c14);
    }

    blockquote {
      padding: 0 1em;
      border-left: 2px solid #B2A497;
      border-bottom: 2px solid #B2A497;
    }

    .youtube-video {
      aspect-ratio: 16 / 9;
      width: 100%;
    }

    ul#articles li {
      list-style-type: square;
      color: var(--c2);
    }

    ul#articles {
      padding: 0 0 0 1em;
    }

    nav a {
      text-decoration: none;
      color: var(--c0);
    }

    nav a span {
      color: var(--c5);
    }

    a.active {
      text-decoration: underline;
    }

    a.tag {
      color: darkolivegreen;
      justify-content: center;
    }

    main,
    header {
      margin: 0 auto;
      box-sizing: border-box;
    }

    main {
      margin: 1rem 0;
      padding: 0 1rem;
    }

    main a {
      color: var(--c10);
      text-decoration: underline;
    }

    nav {
      background: var(--c7);
      padding: 0 1rem;
    }

    nav .wrapper {
      display: flex;
      align-content: center;
      gap: 0 1rem;
      flex-wrap: wrap;

    }

    main nav,
    table {
      background: transparent;
      padding: 1rem;
      border: 4px double var(--c3);
      margin: 0 auto;
    }

    main nav a {
      // color: var(--c2);
    }

    .pagination {
      text-align: center;
    }

    p:has(> img:only-child) {
      display: flex;
      justify-content: center;
      border: calc(var(--ln) * 2) double var(--c3)
    }

    img {
      max-width: 80%;
    }

    @media only screen and (max-width: 500px) {

      header,
      main {
        padding: 1em;
      }

      ul#articles li a {
        display: block
      }
    }

    main> :first-child {
      margin-top: 0;
    }
  </style>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="content-language" content="en">

  
  
  <script type="text/javascript">
  (function (c, l, a, r, i, t, y) {
    c[a] = c[a] || function () {(c[a].q = c[a].q || []).push(arguments)};
    t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
    y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
  })(window, document, "clarity", "script", "p841gcyf0p");
</script>
  <!-- Primary Meta Tags -->
  <title>Counting Unique Elements in Django Queries Using `annotate` â€” Mirat Can Bayrak</title>
  <link rel='canonical' href="https://mirat.dev/articles/djangoda-sorgu-yorumlama-annotate-isleminde-farkli-elemanlari-saydirmak/">
  
  <meta name="title" content="Counting Unique Elements in Django Queries Using `annotate` - Mirat Can
  Bayrak" />
  <meta name="description" content="" />
  <meta property="og:type" content="website" />
<meta property="og:url" content="https://mirat.dev/articles/djangoda-sorgu-yorumlama-annotate-isleminde-farkli-elemanlari-saydirmak" />
<meta property="og:title" content="Counting Unique Elements in Django Queries Using `annotate` - Mirat Can
  Bayrak" />
<meta property="og:description" content="" />
<meta property="og:image" content="https://mirat.dev/articles/djangoda-sorgu-yorumlama-annotate-isleminde-farkli-elemanlari-saydirmak" />
  <meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content="https://mirat.dev/articles/djangoda-sorgu-yorumlama-annotate-isleminde-farkli-elemanlari-saydirmak" />
<meta property="twitter:title" content="Counting Unique Elements in Django Queries Using `annotate` - Mirat Can
  Bayrak" />
<meta property="twitter:description" content="" />
<meta property="twitter:image" content="https://mirat.dev/articles/djangoda-sorgu-yorumlama-annotate-isleminde-farkli-elemanlari-saydirmak" />
  
  
  
    <link rel="stylesheet" href="../../static/pygments.css">
  

</head>

<body>
  <div class="screen">
    <header>
      <nav>
  <div class="wrapper">
    <a  href="/"><span>H</span>ome</a>
    
    <a  class="active"  href="/articles/"><span>A</span>rticles</a>
    

    
    <a  href="/projects/"><span>P</span>rojects</a>
    

    
    <a  href="/links/"><span>L</span>inks</a>
    

    
    <a  href="/products/"><span>W</span>ishlist</a>
    

    <a target="_blank" href="/resume/resume.html"><span>R</span>esume</a>
  </div>
</nav>
    </header>
    <main>
      <div class="wrapper">
        

<h1>Counting Unique Elements in Django Queries Using `annotate`</h1>
<p>An interesting question popped up on the <strong>Python Istanbul</strong> mailing group, and I thought it would be useful to take note of it here. You can find the original discussion <a href="https://groups.google.com/forum/?fromgroups#!topic/python-istanbul/IAscvyQ7Euk">here</a>.</p>
<p>A developer has three models: <strong>Category</strong>, <strong>Author</strong>, and <strong>Post</strong>. Here's how they are structured:</p>
<div class="hll"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">slug</span> <span class="o">=</span> <span class="o">...</span>
    <span class="n">name</span> <span class="o">=</span> <span class="o">...</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Post</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="o">...</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Author&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Author</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="o">...</span>
</pre></div>
<p>The goal is to generate a list of categories along with the number of <strong>unique authors</strong> who have written posts for each category. For example, the desired result might look like this:</p>
<table>
<thead><tr>
<th><code>category_id</code></th>
<th><code>category</code></th>
<th><code>post_count</code></th>
<th><code>author_count</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>Django</td>
<td>4</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>Python</td>
<td>3</td>
<td>3</td>
</tr>
</tbody>
</table>
<h2>The Initial Query</h2>
<p>To get this result, the user used <strong>grouping</strong> and wrote the following query:</p>
<div class="hll"><pre><span></span><span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">author_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;post__author&#39;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-author_count&#39;</span><span class="p">)</span>
</pre></div>
<p>At first glance, this looks like it should work: it retrieves the number of authors for each category by using <code>Count</code> on <code>post__author</code>. However, there's a problem.</p>
<h2>The Problem: Counting Non-Unique Authors</h2>
<p>If an author has multiple posts in a category, they are counted multiple times. For instance, if two authors each write two posts in the same category, this query will count four authors instead of two. This leads to incorrect results.</p>
<h2>The Solution: Using <code>distinct=True</code></h2>
<p>To fix this issue, you need to ensure that the query only counts <strong>unique authors</strong> for each category. Django provides the <code>distinct=True</code> parameter for the <code>Count</code> function, which ensures that duplicates are excluded. Here's the corrected query:</p>
<div class="hll"><pre><span></span><span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">author_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;post__author&#39;</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-author_count&#39;</span><span class="p">)</span>
</pre></div>
<p>With this modification, the query correctly counts the unique authors for each category, providing the desired results.</p>
<h2>Why Use <code>distinct</code>?</h2>
<p>The <code>distinct=True</code> parameter ensures that duplicates are ignored when counting. Without it, <code>Count</code> includes all occurrences, which can lead to inflated numbers when there are multiple posts by the same author in a category.</p>
<p>This approach is both efficient and clean, making it a valuable tool for similar use cases where unique counts are needed in Django queries.</p>

03/2012


  <ul>
    <li>
        <a href="../tag/django-notes/">
          All posts tagged django-notes
        </a>
      </li>
    
  </ul>



      </div>
    </main>
  </div>
  
<script src="https://utteranc.es/client.js"
        repo="miratcan/miratcan.github.io"
        issue-term="title"
        label="Comment"
        theme="github-dark"
        crossorigin="anonymous"
        async>
</script>

</body>

</html>
