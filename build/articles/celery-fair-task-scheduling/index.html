<!DOCTYPE html>
<html lang="en">

<head>
  <style>
    @font-face {
      font-family: Dos;
      src: url(/dos.ttf);
    }

    :root {
      --c0: #000000;
      --c1: #000080;
      --c2: #00aaaa;
      --c3: #00aa00;
      --c4: #aa00aa;
      --c5: #aa0000;
      --c6: #aa5500;
      --c7: #aaaaaa;
      --c8: #555555;
      --c9: #5555ff;
      --c10: #1fdbdb;
      --c12: #55ff55;
      --c12: #ff55ff;
      --c13: #ff5555;
      --c14: #ffff55;
      --c15: #ffffff;
      --ln: 2px;
      --gap: 1rem;
      --fs: 16px;
      --lh: 24px;
    }

    em {
      color: var(--c6);
      font-style: normal;
    }

    strong {
      font-weight: normal;
      color: var(--c15);
    }

    ::-webkit-scrollbar {
      width: var(--gap)
    }

    ::-webkit-scrollbar-track {
      background: var(--c7);
    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
      background: var(--c8);
    }

    /* Handle on hover */
    ::-webkit-scrollbar-thumb:hover {
      background: var(--c4);
    }

    .screen *:not(pre) {
      font-size: inherit;
      line-height: inherit;
    }

    .wrapper {
      max-width: 800px;
      margin: 0 auto;
    }

    html,
    body {
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--c0);
      color: var(--c7);
      font-family: 'Dos', monospace;
      font-size: var(--fs);
      line-height: var(--lh);
      vertical-align: center;
      font-smooth: never;
      -webkit-font-smoothing: none;
      letter-spacing: -1px;
    }

    pre {
      font-family: inherit;
      padding: 1rem;
      background: #111;
      border: 1px solid gray;
      overflow-y: scroll;
    }

    code {
      color: var(--c3);
      font-family: inherit;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    p,
    li,
    table,
    blockquote {
      font-weight: normal;
      margin: 0 0 1rem 0;
      font-family: inherit;
      font-size: inherit;
      line-height: inherit;
      letter-spacing: inherit;
    }

    li {
      margin: 0;
    }

    h1 {
      font-size: 1.4em;
      line-height: 1.73em;
      text-transform: uppercase;
      text-align: center;
    }

    h2 {
      font-size: 1.3em;
      line-height: 1.61em;
      border-bottom: 4px double var(--c4);
    }

    h3 {
      line-height: 1.48em;
    }

    h1,
    h2,
    h3 {
      color: var(--c14);
    }

    blockquote {
      padding: 0 1em;
      border-left: 2px solid #B2A497;
      border-bottom: 2px solid #B2A497;
    }

    .youtube-video {
      aspect-ratio: 16 / 9;
      width: 100%;
    }

    ul#articles li {
      list-style-type: square;
      color: var(--c2);
    }

    ul#articles {
      padding: 0 0 0 1em;
    }

    nav a {
      text-decoration: none;
      color: var(--c0);
    }

    nav a span {
      color: var(--c5);
    }

    a.active {
      text-decoration: underline;
    }

    a.tag {
      color: darkolivegreen;
      justify-content: center;
    }

    main,
    header {
      margin: 0 auto;
      box-sizing: border-box;
    }

    main {
      margin: 1rem 0;
      padding: 0 1rem;
    }

    main a {
      color: var(--c10);
      text-decoration: underline;
    }

    nav {
      background: var(--c7);
      padding: 0 1rem;
    }

    nav .wrapper {
      display: flex;
      align-content: center;
      gap: 0 1rem;
      flex-wrap: wrap;

    }

    main nav,
    table {
      background: transparent;
      padding: 1rem;
      border: 4px double var(--c3);
      margin: 0 auto;
    }

    main nav a {
      // color: var(--c2);
    }

    .pagination {
      text-align: center;
    }

    p:has(> img:only-child) {
      display: flex;
      justify-content: center;
      border: calc(var(--ln) * 2) double var(--c3)
    }

    img {
      max-width: 80%;
    }

    @media only screen and (max-width: 500px) {

      header,
      main {
        padding: 1em;
      }

      ul#articles li a {
        display: block
      }
    }

    main> :first-child {
      margin-top: 0;
    }
  </style>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="content-language" content="en">

  
  
  <script type="text/javascript">
  (function (c, l, a, r, i, t, y) {
    c[a] = c[a] || function () {(c[a].q = c[a].q || []).push(arguments)};
    t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
    y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
  })(window, document, "clarity", "script", "p841gcyf0p");
</script>
  <!-- Primary Meta Tags -->
  <title>Fair Task Scheduling Beats Plain Celery Queues — Mirat Can Bayrak</title>
  <link rel='canonical' href="https://mirat.dev/articles/celery-fair-task-scheduling/">
  
  <meta name="title" content="Fair Task Scheduling Beats Plain Celery Queues - Mirat Can
  Bayrak" />
  <meta name="description" content="Why classic Celery queues starve small tenants and how multi-tenant fair scheduling (with fairque) keeps background tasks balanced." />
  <meta property="og:type" content="website" />
<meta property="og:url" content="https://mirat.dev/articles/celery-fair-task-scheduling" />
<meta property="og:title" content="Fair Task Scheduling Beats Plain Celery Queues - Mirat Can
  Bayrak" />
<meta property="og:description" content="Why classic Celery queues starve small tenants and how multi-tenant fair scheduling (with fairque) keeps background tasks balanced." />
<meta property="og:image" content="https://mirat.dev/articles/celery-fair-task-scheduling" />
  <meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content="https://mirat.dev/articles/celery-fair-task-scheduling" />
<meta property="twitter:title" content="Fair Task Scheduling Beats Plain Celery Queues - Mirat Can
  Bayrak" />
<meta property="twitter:description" content="Why classic Celery queues starve small tenants and how multi-tenant fair scheduling (with fairque) keeps background tasks balanced." />
<meta property="twitter:image" content="https://mirat.dev/articles/celery-fair-task-scheduling" />
  
  
  
    <link rel="stylesheet" href="../../static/pygments.css">
  

</head>

<body>
  <div class="screen">
    <header>
      <nav>
  <div class="wrapper">
    <a  href="/"><span>H</span>ome</a>
    
    <a  class="active"  href="/articles/"><span>A</span>rticles</a>
    

    
    <a  href="/projects/"><span>P</span>rojects</a>
    

    
    <a  href="/links/"><span>L</span>inks</a>
    

    
    <a  href="/products/"><span>W</span>ishlist</a>
    

    <a target="_blank" href="/resume/resume.html"><span>R</span>esume</a>
  </div>
</nav>
    </header>
    <main>
      <div class="wrapper">
        

<h1>Fair Task Scheduling Beats Plain Celery Queues</h1>
<p>Background jobs look easy on paper, yet they are far messier in the real world. The default answer in the Python community is usually “just add Celery with an AMQP broker.” That works until you need fairness.</p>
<p>Imagine a service that backs up YouTube channels:</p>
<ul>
<li>MrBeast signs in and requests backups for roughly 890 videos.</li>
<li>Ahmet signs in with a small channel that has only 10 videos.</li>
</ul>
<p>If your workers chew through every MrBeast job before even touching Ahmet’s queue, you have just crafted a terrible user experience. Ahmet connected the account, waited four hours, and nothing moved.</p>
<h3>Naïve fixes that hurt</h3>
<ol>
<li><p><strong>One queue per user on the same worker</strong></p>
<p>You keep everything on one server, create a queue per user, and spawn a worker per queue. Before long the worker host begs for mercy—RAM, file descriptors, and Celery bookkeeping all stack up.</p>
</li>
<li><p><strong>One queue per user on dedicated hosts</strong></p>
<p>You scale out, spin up worker fleets for large customers, and isolate queues. Congratulations on the USD 2,000 cloud invoice (and the ensuing domestic argument).</p>
</li>
</ol>
<p>Neither option solves the original fairness problem without painful trade-offs.</p>
<h3>Multi-tenant fair scheduling to the rescue</h3>
<p>There is a third option: multi-tenant fair scheduling. Instead of consuming jobs in a strict FIFO order, the dispatcher rotates through tenants. Picture a single cauldron full of jobs where every customer dips their own ladle in turn. Large tenants cannot monopolise the queue, and small tenants are not starved.</p>
<h3>Trade-offs you should acknowledge</h3>
<ul>
<li><strong>Predictability drops.</strong> Promise-by-exact-hour estimates are hard because work jumps between tenants. (Celery-by-default cannot promise accurate ETAs either.)</li>
<li><strong>Big tenants slow down.</strong> MrBeast will notice occasional waits because he must share the worker pool.</li>
<li><strong>Implementation gets trickier.</strong> You have to balance jobs by both timestamp and tenant identity.</li>
<li><strong>Capacity planning becomes political.</strong> You might decide that premium tenants deserve more turns, or cap the share of free users.</li>
<li><strong>Latency can ripple.</strong> Frequent context switches can shift throughput.</li>
</ul>
<p>Even with these caveats, fair scheduling is worth it. It respects every customer and keeps the service responsive.</p>
<h3>Use a purpose-built queue instead of bending Celery</h3>
<p>Yes, you could bolt fairness into Celery with custom routers, per-user queues, and scripts that rebalance workers. You would also inherit a lifetime of maintenance debt.</p>
<p>A cleaner alternative is <a href="https://github.com/miratcan/fairque">fairque</a>:</p>
<div class="hll"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fairque</span><span class="w"> </span><span class="kn">import</span> <span class="n">FairQueue</span>

<span class="n">queue</span> <span class="o">=</span> <span class="n">FairQueue</span><span class="p">(</span><span class="n">redis_url</span><span class="o">=</span><span class="s2">&quot;redis://localhost/0&quot;</span><span class="p">)</span>
<span class="n">queue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="s2">&quot;backup_video&quot;</span><span class="p">,</span> <span class="n">tenant</span><span class="o">=</span><span class="s2">&quot;mrbeast&quot;</span><span class="p">,</span> <span class="n">video_id</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
<span class="n">queue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="s2">&quot;backup_video&quot;</span><span class="p">,</span> <span class="n">tenant</span><span class="o">=</span><span class="s2">&quot;ahmet&quot;</span><span class="p">,</span> <span class="n">video_id</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
<p>Fairque stores jobs in Redis, performs round-robin dispatch across tenants, and even ships extras such as priorities and DAG support out of the box.</p>
<p>If you ever replaced a “we have always done it this way” Celery pattern with a fairer alternative, share it—I am all ears. Maybe your fix lights the way for someone else, including me. 💡</p>

08/2025


  <ul>
    <li>
        <a href="../tag/python-notes/">
          All posts tagged python-notes
        </a>
      </li>
    
  </ul>



      </div>
    </main>
  </div>
  
<script src="https://utteranc.es/client.js"
        repo="miratcan/miratcan.github.io"
        issue-term="title"
        label="Comment"
        theme="github-dark"
        crossorigin="anonymous"
        async>
</script>

</body>

</html>
